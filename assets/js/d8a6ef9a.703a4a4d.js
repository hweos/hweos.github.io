"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7257],{8453:(n,e,s)=>{s.d(e,{R:()=>a,x:()=>t});var i=s(6540);const l={},r=i.createContext(l);function a(n){const e=i.useContext(r);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:a(n.components),i.createElement(r.Provider,{value:e},n.children)}},8996:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>c,contentTitle:()=>t,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"misc/nginx-guide","title":"Nginx \u914d\u7f6e\u901f\u67e5","description":"Nginx \u53cd\u5411\u4ee3\u7406\u3001HTTPS\u3001\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e\u6307\u5357","source":"@site/docs/misc/nginx-guide.mdx","sourceDirName":"misc","slug":"/misc/nginx-guide","permalink":"/docs/misc/nginx-guide","draft":false,"unlisted":false,"editUrl":"https://github.com/hweos/git-pages/edit/main/docs/misc/nginx-guide.mdx","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8,"slug":"nginx-guide","title":"Nginx \u914d\u7f6e\u901f\u67e5","description":"Nginx \u53cd\u5411\u4ee3\u7406\u3001HTTPS\u3001\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e\u6307\u5357"},"sidebar":"docsSidebar","previous":{"title":"Docker \u5165\u95e8\u6307\u5357","permalink":"/docs/misc/docker-guide"},"next":{"title":"Linux \u5e38\u7528\u547d\u4ee4","permalink":"/docs/misc/linux-commands"}}');var l=s(4848),r=s(8453);const a={sidebar_position:8,slug:"nginx-guide",title:"Nginx \u914d\u7f6e\u901f\u67e5",description:"Nginx \u53cd\u5411\u4ee3\u7406\u3001HTTPS\u3001\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e\u6307\u5357"},t="Nginx \u914d\u7f6e\u901f\u67e5",c={},d=[{value:"\ud83d\udcc1 \u914d\u7f6e\u6587\u4ef6\u7ed3\u6784",id:"-\u914d\u7f6e\u6587\u4ef6\u7ed3\u6784",level:2},{value:"\ud83d\udd27 \u57fa\u7840\u914d\u7f6e",id:"-\u57fa\u7840\u914d\u7f6e",level:2},{value:"\u9759\u6001\u6587\u4ef6\u670d\u52a1",id:"\u9759\u6001\u6587\u4ef6\u670d\u52a1",level:3},{value:"SPA \u5e94\u7528\u914d\u7f6e",id:"spa-\u5e94\u7528\u914d\u7f6e",level:3},{value:"\ud83d\udd04 \u53cd\u5411\u4ee3\u7406",id:"-\u53cd\u5411\u4ee3\u7406",level:2},{value:"\u57fa\u7840\u4ee3\u7406",id:"\u57fa\u7840\u4ee3\u7406",level:3},{value:"WebSocket \u4ee3\u7406",id:"websocket-\u4ee3\u7406",level:3},{value:"\u591a\u8def\u5f84\u4ee3\u7406",id:"\u591a\u8def\u5f84\u4ee3\u7406",level:3},{value:"\ud83d\udd12 HTTPS \u914d\u7f6e",id:"-https-\u914d\u7f6e",level:2},{value:"Let&#39;s Encrypt \u8bc1\u4e66",id:"lets-encrypt-\u8bc1\u4e66",level:3},{value:"\u4f7f\u7528 Certbot \u83b7\u53d6\u8bc1\u4e66",id:"\u4f7f\u7528-certbot-\u83b7\u53d6\u8bc1\u4e66",level:3},{value:"\u2696\ufe0f \u8d1f\u8f7d\u5747\u8861",id:"\ufe0f-\u8d1f\u8f7d\u5747\u8861",level:2},{value:"\u8f6e\u8be2\uff08\u9ed8\u8ba4\uff09",id:"\u8f6e\u8be2\u9ed8\u8ba4",level:3},{value:"\u6743\u91cd\u5206\u914d",id:"\u6743\u91cd\u5206\u914d",level:3},{value:"IP Hash\uff08\u4f1a\u8bdd\u4fdd\u6301\uff09",id:"ip-hash\u4f1a\u8bdd\u4fdd\u6301",level:3},{value:"\u5065\u5eb7\u68c0\u67e5",id:"\u5065\u5eb7\u68c0\u67e5",level:3},{value:"\ud83d\udee1\ufe0f \u5b89\u5168\u914d\u7f6e",id:"\ufe0f-\u5b89\u5168\u914d\u7f6e",level:2},{value:"\u57fa\u7840\u5b89\u5168\u5934",id:"\u57fa\u7840\u5b89\u5168\u5934",level:3},{value:"\u9650\u6d41",id:"\u9650\u6d41",level:3},{value:"IP \u767d\u540d\u5355/\u9ed1\u540d\u5355",id:"ip-\u767d\u540d\u5355\u9ed1\u540d\u5355",level:3},{value:"\u57fa\u7840\u8ba4\u8bc1",id:"\u57fa\u7840\u8ba4\u8bc1",level:3},{value:"\ud83d\udcca \u6027\u80fd\u4f18\u5316",id:"-\u6027\u80fd\u4f18\u5316",level:2},{value:"Gzip \u538b\u7f29",id:"gzip-\u538b\u7f29",level:3},{value:"\u7f13\u5b58\u914d\u7f6e",id:"\u7f13\u5b58\u914d\u7f6e",level:3},{value:"\u8fde\u63a5\u4f18\u5316",id:"\u8fde\u63a5\u4f18\u5316",level:3},{value:"\ud83d\udd0d \u5e38\u7528\u547d\u4ee4",id:"-\u5e38\u7528\u547d\u4ee4",level:2},{value:"\ud83d\udcda \u63a8\u8350\u8d44\u6e90",id:"-\u63a8\u8350\u8d44\u6e90",level:2}];function o(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.header,{children:(0,l.jsx)(e.h1,{id:"nginx-\u914d\u7f6e\u901f\u67e5",children:"Nginx \u914d\u7f6e\u901f\u67e5"})}),"\n",(0,l.jsx)(e.p,{children:"Nginx \u662f\u9ad8\u6027\u80fd\u7684 Web \u670d\u52a1\u5668\u548c\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668\u3002\u672c\u6587\u603b\u7ed3\u5e38\u7528\u914d\u7f6e\u3002"}),"\n",(0,l.jsx)(e.h2,{id:"-\u914d\u7f6e\u6587\u4ef6\u7ed3\u6784",children:"\ud83d\udcc1 \u914d\u7f6e\u6587\u4ef6\u7ed3\u6784"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"/etc/nginx/\n\u251c\u2500\u2500 nginx.conf          # \u4e3b\u914d\u7f6e\n\u251c\u2500\u2500 conf.d/             # \u81ea\u5b9a\u4e49\u914d\u7f6e\n\u2502   \u2514\u2500\u2500 default.conf\n\u251c\u2500\u2500 sites-available/    # \u53ef\u7528\u7ad9\u70b9\n\u251c\u2500\u2500 sites-enabled/      # \u5df2\u542f\u7528\u7ad9\u70b9\n\u2514\u2500\u2500 snippets/           # \u914d\u7f6e\u7247\u6bb5\n"})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"-\u57fa\u7840\u914d\u7f6e",children:"\ud83d\udd27 \u57fa\u7840\u914d\u7f6e"}),"\n",(0,l.jsx)(e.h3,{id:"\u9759\u6001\u6587\u4ef6\u670d\u52a1",children:"\u9759\u6001\u6587\u4ef6\u670d\u52a1"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:'server {\n    listen 80;\n    server_name example.com;\n    \n    root /var/www/html;\n    index index.html;\n    \n    location / {\n        try_files $uri $uri/ =404;\n    }\n    \n    # \u9759\u6001\u8d44\u6e90\u7f13\u5b58\n    location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg)$ {\n        expires 30d;\n        add_header Cache-Control "public, immutable";\n    }\n}\n'})}),"\n",(0,l.jsx)(e.h3,{id:"spa-\u5e94\u7528\u914d\u7f6e",children:"SPA \u5e94\u7528\u914d\u7f6e"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:"server {\n    listen 80;\n    server_name app.example.com;\n    \n    root /var/www/app;\n    index index.html;\n    \n    # \u6240\u6709\u8def\u7531\u6307\u5411 index.html\n    location / {\n        try_files $uri $uri/ /index.html;\n    }\n    \n    # API \u4ee3\u7406\n    location /api/ {\n        proxy_pass http://localhost:3000/;\n    }\n}\n"})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"-\u53cd\u5411\u4ee3\u7406",children:"\ud83d\udd04 \u53cd\u5411\u4ee3\u7406"}),"\n",(0,l.jsx)(e.h3,{id:"\u57fa\u7840\u4ee3\u7406",children:"\u57fa\u7840\u4ee3\u7406"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:"server {\n    listen 80;\n    server_name api.example.com;\n    \n    location / {\n        proxy_pass http://localhost:3000;\n        proxy_http_version 1.1;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"websocket-\u4ee3\u7406",children:"WebSocket \u4ee3\u7406"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:'location /ws/ {\n    proxy_pass http://localhost:3001;\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection "upgrade";\n    proxy_set_header Host $host;\n    proxy_read_timeout 86400;\n}\n'})}),"\n",(0,l.jsx)(e.h3,{id:"\u591a\u8def\u5f84\u4ee3\u7406",children:"\u591a\u8def\u5f84\u4ee3\u7406"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:"server {\n    listen 80;\n    server_name example.com;\n    \n    # \u524d\u7aef\n    location / {\n        proxy_pass http://localhost:3000;\n    }\n    \n    # \u540e\u7aef API\n    location /api/ {\n        proxy_pass http://localhost:8080/;\n    }\n    \n    # \u7ba1\u7406\u540e\u53f0\n    location /admin/ {\n        proxy_pass http://localhost:8081/;\n    }\n}\n"})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"-https-\u914d\u7f6e",children:"\ud83d\udd12 HTTPS \u914d\u7f6e"}),"\n",(0,l.jsx)(e.h3,{id:"lets-encrypt-\u8bc1\u4e66",children:"Let's Encrypt \u8bc1\u4e66"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:'server {\n    listen 80;\n    server_name example.com;\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    server_name example.com;\n    \n    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;\n    \n    # SSL \u4f18\u5316\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;\n    ssl_prefer_server_ciphers off;\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_timeout 1d;\n    \n    # HSTS\n    add_header Strict-Transport-Security "max-age=31536000" always;\n    \n    root /var/www/html;\n    index index.html;\n}\n'})}),"\n",(0,l.jsx)(e.h3,{id:"\u4f7f\u7528-certbot-\u83b7\u53d6\u8bc1\u4e66",children:"\u4f7f\u7528 Certbot \u83b7\u53d6\u8bc1\u4e66"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"# \u5b89\u88c5 Certbot\nsudo apt install certbot python3-certbot-nginx\n\n# \u83b7\u53d6\u8bc1\u4e66\nsudo certbot --nginx -d example.com -d www.example.com\n\n# \u81ea\u52a8\u7eed\u671f\nsudo certbot renew --dry-run\n"})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"\ufe0f-\u8d1f\u8f7d\u5747\u8861",children:"\u2696\ufe0f \u8d1f\u8f7d\u5747\u8861"}),"\n",(0,l.jsx)(e.h3,{id:"\u8f6e\u8be2\u9ed8\u8ba4",children:"\u8f6e\u8be2\uff08\u9ed8\u8ba4\uff09"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:"upstream backend {\n    server 127.0.0.1:3001;\n    server 127.0.0.1:3002;\n    server 127.0.0.1:3003;\n}\n\nserver {\n    listen 80;\n    \n    location / {\n        proxy_pass http://backend;\n    }\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u6743\u91cd\u5206\u914d",children:"\u6743\u91cd\u5206\u914d"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:"upstream backend {\n    server 127.0.0.1:3001 weight=3;\n    server 127.0.0.1:3002 weight=2;\n    server 127.0.0.1:3003 weight=1;\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"ip-hash\u4f1a\u8bdd\u4fdd\u6301",children:"IP Hash\uff08\u4f1a\u8bdd\u4fdd\u6301\uff09"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:"upstream backend {\n    ip_hash;\n    server 127.0.0.1:3001;\n    server 127.0.0.1:3002;\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u5065\u5eb7\u68c0\u67e5",children:"\u5065\u5eb7\u68c0\u67e5"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:"upstream backend {\n    server 127.0.0.1:3001 max_fails=3 fail_timeout=30s;\n    server 127.0.0.1:3002 max_fails=3 fail_timeout=30s;\n    server 127.0.0.1:3003 backup;  # \u5907\u7528\u670d\u52a1\u5668\n}\n"})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"\ufe0f-\u5b89\u5168\u914d\u7f6e",children:"\ud83d\udee1\ufe0f \u5b89\u5168\u914d\u7f6e"}),"\n",(0,l.jsx)(e.h3,{id:"\u57fa\u7840\u5b89\u5168\u5934",children:"\u57fa\u7840\u5b89\u5168\u5934"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:'# \u9690\u85cf\u7248\u672c\u53f7\nserver_tokens off;\n\n# \u5b89\u5168\u5934\nadd_header X-Frame-Options "SAMEORIGIN" always;\nadd_header X-Content-Type-Options "nosniff" always;\nadd_header X-XSS-Protection "1; mode=block" always;\nadd_header Referrer-Policy "strict-origin-when-cross-origin" always;\n'})}),"\n",(0,l.jsx)(e.h3,{id:"\u9650\u6d41",children:"\u9650\u6d41"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:"# \u5b9a\u4e49\u9650\u6d41\u533a\u57df\nlimit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;\n\nserver {\n    location /api/ {\n        limit_req zone=api burst=20 nodelay;\n        proxy_pass http://localhost:3000;\n    }\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"ip-\u767d\u540d\u5355\u9ed1\u540d\u5355",children:"IP \u767d\u540d\u5355/\u9ed1\u540d\u5355"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:"# \u767d\u540d\u5355\nlocation /admin/ {\n    allow 192.168.1.0/24;\n    allow 10.0.0.1;\n    deny all;\n    proxy_pass http://localhost:8080;\n}\n\n# \u9ed1\u540d\u5355\nlocation / {\n    deny 192.168.1.100;\n    deny 10.0.0.0/8;\n    allow all;\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u57fa\u7840\u8ba4\u8bc1",children:"\u57fa\u7840\u8ba4\u8bc1"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"# \u521b\u5efa\u5bc6\u7801\u6587\u4ef6\nsudo htpasswd -c /etc/nginx/.htpasswd admin\n"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:'location /admin/ {\n    auth_basic "Admin Area";\n    auth_basic_user_file /etc/nginx/.htpasswd;\n    proxy_pass http://localhost:8080;\n}\n'})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"-\u6027\u80fd\u4f18\u5316",children:"\ud83d\udcca \u6027\u80fd\u4f18\u5316"}),"\n",(0,l.jsx)(e.h3,{id:"gzip-\u538b\u7f29",children:"Gzip \u538b\u7f29"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:"gzip on;\ngzip_vary on;\ngzip_min_length 1024;\ngzip_comp_level 5;\ngzip_types\n    text/plain\n    text/css\n    text/javascript\n    application/javascript\n    application/json\n    application/xml\n    image/svg+xml;\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u7f13\u5b58\u914d\u7f6e",children:"\u7f13\u5b58\u914d\u7f6e"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:"# \u4ee3\u7406\u7f13\u5b58\nproxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m;\n\nserver {\n    location / {\n        proxy_cache my_cache;\n        proxy_cache_valid 200 60m;\n        proxy_cache_valid 404 1m;\n        add_header X-Cache-Status $upstream_cache_status;\n        proxy_pass http://backend;\n    }\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u8fde\u63a5\u4f18\u5316",children:"\u8fde\u63a5\u4f18\u5316"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-nginx",children:"# \u5728 http \u5757\u4e2d\nkeepalive_timeout 65;\nkeepalive_requests 100;\n\n# upstream \u8fde\u63a5\u6c60\nupstream backend {\n    server 127.0.0.1:3000;\n    keepalive 32;\n}\n"})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"-\u5e38\u7528\u547d\u4ee4",children:"\ud83d\udd0d \u5e38\u7528\u547d\u4ee4"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"# \u6d4b\u8bd5\u914d\u7f6e\nsudo nginx -t\n\n# \u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\nsudo nginx -s reload\n\n# \u542f\u52a8/\u505c\u6b62/\u91cd\u542f\nsudo systemctl start nginx\nsudo systemctl stop nginx\nsudo systemctl restart nginx\n\n# \u67e5\u770b\u72b6\u6001\nsudo systemctl status nginx\n\n# \u67e5\u770b\u65e5\u5fd7\ntail -f /var/log/nginx/access.log\ntail -f /var/log/nginx/error.log\n"})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"-\u63a8\u8350\u8d44\u6e90",children:"\ud83d\udcda \u63a8\u8350\u8d44\u6e90"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://nginx.org/en/docs/",children:"Nginx \u5b98\u65b9\u6587\u6863"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.digitalocean.com/community/tools/nginx",children:"Nginx Config Generator"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://ssl-config.mozilla.org/",children:"Mozilla SSL \u914d\u7f6e\u751f\u6210\u5668"})}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(o,{...n})}):o(n)}}}]);