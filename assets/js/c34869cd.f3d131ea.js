"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[8187],{1391:n=>{n.exports=JSON.parse('{"permalink":"/blog/file-upload","editUrl":"https://github.com/hweos/git-pages/edit/main/blog/2025-03-10-file-upload.md","source":"@site/blog/2025-03-10-file-upload.md","title":"\u6587\u4ef6\u4e0a\u4f20\u5b8c\u6574\u65b9\u6848","description":"\u6587\u4ef6\u4e0a\u4f20\u662f Web \u5f00\u53d1\u4e2d\u7684\u5e38\u89c1\u9700\u6c42\u3002\u672c\u6587\u4ecb\u7ecd\u6587\u4ef6\u4e0a\u4f20\u7684\u5b8c\u6574\u5b9e\u73b0\u65b9\u6848\uff0c\u5305\u62ec\u5927\u6587\u4ef6\u5206\u7247\u3001\u65ad\u70b9\u7eed\u4f20\u7b49\u3002","date":"2025-03-10T00:00:00.000Z","tags":[{"inline":true,"label":"\u6587\u4ef6\u4e0a\u4f20","permalink":"/blog/tags/\u6587\u4ef6\u4e0a\u4f20"},{"inline":true,"label":"\u524d\u7aef","permalink":"/blog/tags/\u524d\u7aef"},{"inline":true,"label":"\u540e\u7aef","permalink":"/blog/tags/\u540e\u7aef"}],"readingTime":4.53,"hasTruncateMarker":true,"authors":[{"name":"Mason","title":"Full Stack Developer","url":"https://github.com/HuangZhe007","socials":{"github":"https://github.com/HuangZhe007"},"imageURL":"https://avatars.githubusercontent.com/u/45168628?v=4","key":"mason","page":null}],"frontMatter":{"slug":"file-upload","title":"\u6587\u4ef6\u4e0a\u4f20\u5b8c\u6574\u65b9\u6848","authors":"mason","tags":["\u6587\u4ef6\u4e0a\u4f20","\u524d\u7aef","\u540e\u7aef"]},"unlisted":false,"prevItem":{"title":"\u6570\u636e\u53ef\u89c6\u5316\u5165\u95e8 (ECharts)","permalink":"/blog/data-visualization"},"nextItem":{"title":"\u56fd\u9645\u5316 (i18n) \u6700\u4f73\u5b9e\u8df5","permalink":"/blog/i18n-guide"}}')},7157:(n,e,a)=>{a.r(e),a.d(e,{assets:()=>c,contentTitle:()=>r,default:()=>d,frontMatter:()=>l,metadata:()=>t,toc:()=>o});var t=a(1391),s=a(4848),i=a(8453);const l={slug:"file-upload",title:"\u6587\u4ef6\u4e0a\u4f20\u5b8c\u6574\u65b9\u6848",authors:"mason",tags:["\u6587\u4ef6\u4e0a\u4f20","\u524d\u7aef","\u540e\u7aef"]},r=void 0,c={authorsImageUrls:[void 0]},o=[{value:"\ud83c\udfaf \u4e0a\u4f20\u65b9\u5f0f",id:"-\u4e0a\u4f20\u65b9\u5f0f",level:2},{value:"\ud83d\udce4 \u57fa\u7840\u4e0a\u4f20",id:"-\u57fa\u7840\u4e0a\u4f20",level:2},{value:"\u524d\u7aef",id:"\u524d\u7aef",level:3},{value:"\u4f7f\u7528 fetch",id:"\u4f7f\u7528-fetch",level:3},{value:"\u540e\u7aef (Node.js)",id:"\u540e\u7aef-nodejs",level:3},{value:"\ud83d\udcca \u5206\u7247\u4e0a\u4f20",id:"-\u5206\u7247\u4e0a\u4f20",level:2},{value:"\u524d\u7aef\u5b9e\u73b0",id:"\u524d\u7aef\u5b9e\u73b0",level:3},{value:"\u5e76\u53d1\u4e0a\u4f20",id:"\u5e76\u53d1\u4e0a\u4f20",level:3},{value:"\u540e\u7aef\u5408\u5e76",id:"\u540e\u7aef\u5408\u5e76",level:3},{value:"\ud83d\udd04 \u65ad\u70b9\u7eed\u4f20",id:"-\u65ad\u70b9\u7eed\u4f20",level:2},{value:"\u524d\u7aef",id:"\u524d\u7aef-1",level:3},{value:"\u540e\u7aef\u72b6\u6001\u67e5\u8be2",id:"\u540e\u7aef\u72b6\u6001\u67e5\u8be2",level:3},{value:"\u26a1 \u79d2\u4f20",id:"-\u79d2\u4f20",level:2},{value:"\ud83d\uddbc\ufe0f \u56fe\u7247\u538b\u7f29",id:"\ufe0f-\u56fe\u7247\u538b\u7f29",level:2},{value:"\ud83c\udfa8 \u62d6\u62fd\u4e0a\u4f20",id:"-\u62d6\u62fd\u4e0a\u4f20",level:2},{value:"\u2705 \u6700\u4f73\u5b9e\u8df5",id:"-\u6700\u4f73\u5b9e\u8df5",level:2}];function h(n){const e={code:"code",h2:"h2",h3:"h3",hr:"hr",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,i.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.p,{children:"\u6587\u4ef6\u4e0a\u4f20\u662f Web \u5f00\u53d1\u4e2d\u7684\u5e38\u89c1\u9700\u6c42\u3002\u672c\u6587\u4ecb\u7ecd\u6587\u4ef6\u4e0a\u4f20\u7684\u5b8c\u6574\u5b9e\u73b0\u65b9\u6848\uff0c\u5305\u62ec\u5927\u6587\u4ef6\u5206\u7247\u3001\u65ad\u70b9\u7eed\u4f20\u7b49\u3002"}),"\n",(0,s.jsx)(e.h2,{id:"-\u4e0a\u4f20\u65b9\u5f0f",children:"\ud83c\udfaf \u4e0a\u4f20\u65b9\u5f0f"}),"\n",(0,s.jsxs)(e.table,{children:[(0,s.jsx)(e.thead,{children:(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.th,{children:"\u65b9\u5f0f"}),(0,s.jsx)(e.th,{children:"\u9002\u7528\u573a\u666f"}),(0,s.jsx)(e.th,{children:"\u590d\u6742\u5ea6"})]})}),(0,s.jsxs)(e.tbody,{children:[(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u666e\u901a\u4e0a\u4f20"}),(0,s.jsx)(e.td,{children:"\u5c0f\u6587\u4ef6"}),(0,s.jsx)(e.td,{children:"\u4f4e"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u5206\u7247\u4e0a\u4f20"}),(0,s.jsx)(e.td,{children:"\u5927\u6587\u4ef6"}),(0,s.jsx)(e.td,{children:"\u4e2d"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u65ad\u70b9\u7eed\u4f20"}),(0,s.jsx)(e.td,{children:"\u5927\u6587\u4ef6\u3001\u7f51\u7edc\u4e0d\u7a33"}),(0,s.jsx)(e.td,{children:"\u9ad8"})]}),(0,s.jsxs)(e.tr,{children:[(0,s.jsx)(e.td,{children:"\u79d2\u4f20"}),(0,s.jsx)(e.td,{children:"\u5df2\u5b58\u5728\u6587\u4ef6"}),(0,s.jsx)(e.td,{children:"\u4e2d"})]})]})]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"-\u57fa\u7840\u4e0a\u4f20",children:"\ud83d\udce4 \u57fa\u7840\u4e0a\u4f20"}),"\n",(0,s.jsx)(e.h3,{id:"\u524d\u7aef",children:"\u524d\u7aef"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:"function FileUpload() {\n  const [file, setFile] = useState<File | null>(null);\n  const [progress, setProgress] = useState(0);\n\n  const handleUpload = async () => {\n    if (!file) return;\n\n    const formData = new FormData();\n    formData.append('file', file);\n\n    const xhr = new XMLHttpRequest();\n    \n    xhr.upload.onprogress = (e) => {\n      if (e.lengthComputable) {\n        setProgress(Math.round((e.loaded / e.total) * 100));\n      }\n    };\n\n    xhr.onload = () => {\n      if (xhr.status === 200) {\n        console.log('\u4e0a\u4f20\u6210\u529f');\n      }\n    };\n\n    xhr.open('POST', '/api/upload');\n    xhr.send(formData);\n  };\n\n  return (\n    <div>\n      <input\n        type=\"file\"\n        onChange={(e) => setFile(e.target.files?.[0] || null)}\n      />\n      <button onClick={handleUpload}>\u4e0a\u4f20</button>\n      <progress value={progress} max=\"100\" />\n    </div>\n  );\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u4f7f\u7528-fetch",children:"\u4f7f\u7528 fetch"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"async function uploadFile(file: File) {\n  const formData = new FormData();\n  formData.append('file', file);\n\n  const response = await fetch('/api/upload', {\n    method: 'POST',\n    body: formData,\n  });\n\n  return response.json();\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u540e\u7aef-nodejs",children:"\u540e\u7aef (Node.js)"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"import express from 'express';\nimport multer from 'multer';\n\nconst upload = multer({\n  dest: 'uploads/',\n  limits: { fileSize: 10 * 1024 * 1024 }, // 10MB\n  fileFilter: (req, file, cb) => {\n    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];\n    if (allowedTypes.includes(file.mimetype)) {\n      cb(null, true);\n    } else {\n      cb(new Error('Invalid file type'));\n    }\n  },\n});\n\napp.post('/api/upload', upload.single('file'), (req, res) => {\n  res.json({\n    filename: req.file.filename,\n    size: req.file.size,\n    path: req.file.path,\n  });\n});\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"-\u5206\u7247\u4e0a\u4f20",children:"\ud83d\udcca \u5206\u7247\u4e0a\u4f20"}),"\n",(0,s.jsx)(e.h3,{id:"\u524d\u7aef\u5b9e\u73b0",children:"\u524d\u7aef\u5b9e\u73b0"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB\n\nasync function uploadLargeFile(file: File) {\n  const chunks = Math.ceil(file.size / CHUNK_SIZE);\n  const fileHash = await calculateHash(file);\n\n  for (let i = 0; i < chunks; i++) {\n    const start = i * CHUNK_SIZE;\n    const end = Math.min(start + CHUNK_SIZE, file.size);\n    const chunk = file.slice(start, end);\n\n    const formData = new FormData();\n    formData.append('chunk', chunk);\n    formData.append('hash', fileHash);\n    formData.append('index', String(i));\n    formData.append('total', String(chunks));\n    formData.append('filename', file.name);\n\n    await fetch('/api/upload/chunk', {\n      method: 'POST',\n      body: formData,\n    });\n\n    console.log(`Uploaded chunk ${i + 1}/${chunks}`);\n  }\n\n  // \u5408\u5e76\u5206\u7247\n  await fetch('/api/upload/merge', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      hash: fileHash,\n      filename: file.name,\n      total: chunks,\n    }),\n  });\n}\n\n// \u8ba1\u7b97\u6587\u4ef6 hash\nasync function calculateHash(file: File): Promise<string> {\n  const buffer = await file.arrayBuffer();\n  const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);\n  const hashArray = Array.from(new Uint8Array(hashBuffer));\n  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u5e76\u53d1\u4e0a\u4f20",children:"\u5e76\u53d1\u4e0a\u4f20"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"async function uploadWithConcurrency(file: File, concurrency = 3) {\n  const chunks = createChunks(file);\n  const fileHash = await calculateHash(file);\n  \n  let current = 0;\n  const results: Promise<void>[] = [];\n\n  const uploadNext = async () => {\n    if (current >= chunks.length) return;\n    \n    const index = current++;\n    const chunk = chunks[index];\n    \n    await uploadChunk(chunk, fileHash, index, chunks.length);\n    await uploadNext();\n  };\n\n  for (let i = 0; i < concurrency; i++) {\n    results.push(uploadNext());\n  }\n\n  await Promise.all(results);\n  await mergeChunks(fileHash, file.name, chunks.length);\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u540e\u7aef\u5408\u5e76",children:"\u540e\u7aef\u5408\u5e76"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"import fs from 'fs';\nimport path from 'path';\n\napp.post('/api/upload/chunk', upload.single('chunk'), (req, res) => {\n  const { hash, index } = req.body;\n  const chunkDir = path.join('uploads', hash);\n  \n  if (!fs.existsSync(chunkDir)) {\n    fs.mkdirSync(chunkDir, { recursive: true });\n  }\n  \n  fs.renameSync(req.file.path, path.join(chunkDir, index));\n  res.json({ success: true });\n});\n\napp.post('/api/upload/merge', async (req, res) => {\n  const { hash, filename, total } = req.body;\n  const chunkDir = path.join('uploads', hash);\n  const filePath = path.join('uploads', filename);\n  \n  const writeStream = fs.createWriteStream(filePath);\n  \n  for (let i = 0; i < total; i++) {\n    const chunkPath = path.join(chunkDir, String(i));\n    const data = fs.readFileSync(chunkPath);\n    writeStream.write(data);\n    fs.unlinkSync(chunkPath);\n  }\n  \n  writeStream.end();\n  fs.rmdirSync(chunkDir);\n  \n  res.json({ success: true, path: filePath });\n});\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"-\u65ad\u70b9\u7eed\u4f20",children:"\ud83d\udd04 \u65ad\u70b9\u7eed\u4f20"}),"\n",(0,s.jsx)(e.h3,{id:"\u524d\u7aef-1",children:"\u524d\u7aef"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"async function resumableUpload(file: File) {\n  const fileHash = await calculateHash(file);\n  const chunks = createChunks(file);\n\n  // \u67e5\u8be2\u5df2\u4e0a\u4f20\u5206\u7247\n  const { uploaded } = await fetch(`/api/upload/status?hash=${fileHash}`)\n    .then(res => res.json());\n\n  for (let i = 0; i < chunks.length; i++) {\n    // \u8df3\u8fc7\u5df2\u4e0a\u4f20\n    if (uploaded.includes(i)) continue;\n\n    await uploadChunk(chunks[i], fileHash, i, chunks.length);\n  }\n\n  await mergeChunks(fileHash, file.name, chunks.length);\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u540e\u7aef\u72b6\u6001\u67e5\u8be2",children:"\u540e\u7aef\u72b6\u6001\u67e5\u8be2"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"app.get('/api/upload/status', (req, res) => {\n  const { hash } = req.query;\n  const chunkDir = path.join('uploads', hash);\n  \n  if (!fs.existsSync(chunkDir)) {\n    return res.json({ uploaded: [] });\n  }\n  \n  const uploaded = fs.readdirSync(chunkDir)\n    .map(name => parseInt(name))\n    .sort((a, b) => a - b);\n  \n  res.json({ uploaded });\n});\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"-\u79d2\u4f20",children:"\u26a1 \u79d2\u4f20"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"async function quickUpload(file: File) {\n  const fileHash = await calculateHash(file);\n\n  // \u68c0\u67e5\u662f\u5426\u5df2\u5b58\u5728\n  const { exists, url } = await fetch(`/api/upload/check?hash=${fileHash}`)\n    .then(res => res.json());\n\n  if (exists) {\n    console.log('\u79d2\u4f20\u6210\u529f');\n    return url;\n  }\n\n  // \u6b63\u5e38\u4e0a\u4f20\n  return await uploadLargeFile(file);\n}\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",children:"// \u540e\u7aef\napp.get('/api/upload/check', (req, res) => {\n  const { hash } = req.query;\n  const file = db.files.findByHash(hash);\n  \n  if (file) {\n    res.json({ exists: true, url: file.url });\n  } else {\n    res.json({ exists: false });\n  }\n});\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"\ufe0f-\u56fe\u7247\u538b\u7f29",children:"\ud83d\uddbc\ufe0f \u56fe\u7247\u538b\u7f29"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-typescript",children:"function compressImage(file: File, maxWidth = 1920, quality = 0.8): Promise<Blob> {\n  return new Promise((resolve) => {\n    const img = new Image();\n    const canvas = document.createElement('canvas');\n    const ctx = canvas.getContext('2d')!;\n\n    img.onload = () => {\n      let { width, height } = img;\n\n      if (width > maxWidth) {\n        height = (maxWidth / width) * height;\n        width = maxWidth;\n      }\n\n      canvas.width = width;\n      canvas.height = height;\n      ctx.drawImage(img, 0, 0, width, height);\n\n      canvas.toBlob(\n        (blob) => resolve(blob!),\n        'image/jpeg',\n        quality\n      );\n    };\n\n    img.src = URL.createObjectURL(file);\n  });\n}\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"-\u62d6\u62fd\u4e0a\u4f20",children:"\ud83c\udfa8 \u62d6\u62fd\u4e0a\u4f20"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:"function DragDropUpload() {\n  const [isDragging, setIsDragging] = useState(false);\n\n  const handleDrop = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(false);\n    \n    const files = Array.from(e.dataTransfer.files);\n    files.forEach(uploadFile);\n  };\n\n  return (\n    <div\n      onDragOver={(e) => {\n        e.preventDefault();\n        setIsDragging(true);\n      }}\n      onDragLeave={() => setIsDragging(false)}\n      onDrop={handleDrop}\n      className={`drop-zone ${isDragging ? 'active' : ''}`}\n    >\n      \u62d6\u62fd\u6587\u4ef6\u5230\u8fd9\u91cc\u4e0a\u4f20\n    </div>\n  );\n}\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h2,{id:"-\u6700\u4f73\u5b9e\u8df5",children:"\u2705 \u6700\u4f73\u5b9e\u8df5"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-markdown",children:"1. \u6587\u4ef6\u9a8c\u8bc1\n   - \u7c7b\u578b\u68c0\u67e5\uff08MIME + \u6269\u5c55\u540d\uff09\n   - \u5927\u5c0f\u9650\u5236\n   - \u5185\u5bb9\u68c0\u67e5\uff08\u9632\u6076\u610f\u6587\u4ef6\uff09\n\n2. \u7528\u6237\u4f53\u9a8c\n   - \u8fdb\u5ea6\u663e\u793a\n   - \u53d6\u6d88\u4e0a\u4f20\n   - \u9519\u8bef\u91cd\u8bd5\n   - \u9884\u89c8\u529f\u80fd\n\n3. \u6027\u80fd\u4f18\u5316\n   - \u5206\u7247\u4e0a\u4f20\n   - \u5e76\u53d1\u63a7\u5236\n   - \u538b\u7f29\u5904\u7406\n\n4. \u5b89\u5168\n   - \u6587\u4ef6\u540d\u5904\u7406\n   - \u5b58\u50a8\u9694\u79bb\n   - \u8bbf\u95ee\u63a7\u5236\n"})}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.p,{children:"\u6587\u4ef6\u4e0a\u4f20\u770b\u4f3c\u7b80\u5355\uff0c\u8981\u505a\u597d\u9700\u8981\u8003\u8651\u5f88\u591a\u7ec6\u8282\u3002\u6839\u636e\u4e1a\u52a1\u573a\u666f\u9009\u62e9\u5408\u9002\u7684\u65b9\u6848\u3002"})]})}function d(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(h,{...n})}):h(n)}},8453:(n,e,a)=>{a.d(e,{R:()=>l,x:()=>r});var t=a(6540);const s={},i=t.createContext(s);function l(n){const e=t.useContext(i);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function r(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:l(n.components),t.createElement(i.Provider,{value:e},n.children)}}}]);