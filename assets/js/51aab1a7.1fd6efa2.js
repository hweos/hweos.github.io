"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9664],{5198:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>o,frontMatter:()=>r,metadata:()=>l,toc:()=>t});const l=JSON.parse('{"id":"misc/pm2-guide","title":"PM2 \u4f7f\u7528\u6307\u5357","description":"Node.js \u8fdb\u7a0b\u7ba1\u7406\u5de5\u5177 PM2 \u7684\u5b8c\u6574\u4f7f\u7528\u6307\u5357","source":"@site/docs/misc/pm2-guide.mdx","sourceDirName":"misc","slug":"/misc/pm2-guide","permalink":"/docs/misc/pm2-guide","draft":false,"unlisted":false,"editUrl":"https://github.com/hweos/git-pages/edit/main/docs/misc/pm2-guide.mdx","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"slug":"pm2-guide","title":"PM2 \u4f7f\u7528\u6307\u5357","description":"Node.js \u8fdb\u7a0b\u7ba1\u7406\u5de5\u5177 PM2 \u7684\u5b8c\u6574\u4f7f\u7528\u6307\u5357"},"sidebar":"docsSidebar","previous":{"title":"NPM \u53d1\u5305\u6307\u5357","permalink":"/docs/misc/npm-publishing"},"next":{"title":"Live Code \u6f14\u793a","permalink":"/docs/misc/live-code"}}');var a=s(4848),i=s(8453);const r={sidebar_position:4,slug:"pm2-guide",title:"PM2 \u4f7f\u7528\u6307\u5357",description:"Node.js \u8fdb\u7a0b\u7ba1\u7406\u5de5\u5177 PM2 \u7684\u5b8c\u6574\u4f7f\u7528\u6307\u5357"},d="PM2 \u4f7f\u7528\u6307\u5357",c={},t=[{value:"\ud83d\udce6 \u5b89\u88c5",id:"-\u5b89\u88c5",level:2},{value:"\ud83d\ude80 \u57fa\u672c\u4f7f\u7528",id:"-\u57fa\u672c\u4f7f\u7528",level:2},{value:"\u542f\u52a8\u5e94\u7528",id:"\u542f\u52a8\u5e94\u7528",level:3},{value:"\u5e38\u7528\u542f\u52a8\u53c2\u6570",id:"\u5e38\u7528\u542f\u52a8\u53c2\u6570",level:3},{value:"\ud83d\udccb \u8fdb\u7a0b\u7ba1\u7406",id:"-\u8fdb\u7a0b\u7ba1\u7406",level:2},{value:"\u67e5\u770b\u8fdb\u7a0b\u5217\u8868",id:"\u67e5\u770b\u8fdb\u7a0b\u5217\u8868",level:3},{value:"\u63a7\u5236\u8fdb\u7a0b",id:"\u63a7\u5236\u8fdb\u7a0b",level:3},{value:"\ud83d\udcdd \u65e5\u5fd7\u7ba1\u7406",id:"-\u65e5\u5fd7\u7ba1\u7406",level:2},{value:"\u2699\ufe0f \u914d\u7f6e\u6587\u4ef6",id:"\ufe0f-\u914d\u7f6e\u6587\u4ef6",level:2},{value:"\u751f\u6210\u914d\u7f6e\u6587\u4ef6",id:"\u751f\u6210\u914d\u7f6e\u6587\u4ef6",level:3},{value:"ecosystem.config.js \u793a\u4f8b",id:"ecosystemconfigjs-\u793a\u4f8b",level:3},{value:"\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u542f\u52a8",id:"\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u542f\u52a8",level:3},{value:"\ud83d\udd04 \u5f00\u673a\u81ea\u542f\u52a8",id:"-\u5f00\u673a\u81ea\u542f\u52a8",level:2},{value:"\ud83d\udcca \u76d1\u63a7\u4e0e\u8bca\u65ad",id:"-\u76d1\u63a7\u4e0e\u8bca\u65ad",level:2},{value:"\ud83c\udf10 PM2 Plus\uff08\u53ef\u9009\uff09",id:"-pm2-plus\u53ef\u9009",level:2},{value:"\ud83d\udca1 \u5e38\u7528\u6280\u5de7",id:"-\u5e38\u7528\u6280\u5de7",level:2},{value:"\u5feb\u901f\u91cd\u542f\u6240\u6709\u5e94\u7528",id:"\u5feb\u901f\u91cd\u542f\u6240\u6709\u5e94\u7528",level:3},{value:"\u4f18\u96c5\u5173\u95ed\u5e94\u7528",id:"\u4f18\u96c5\u5173\u95ed\u5e94\u7528",level:3},{value:"\u67e5\u770b CPU \u548c\u5185\u5b58\u4f7f\u7528",id:"\u67e5\u770b-cpu-\u548c\u5185\u5b58\u4f7f\u7528",level:3},{value:"\u96c6\u7fa4\u6a21\u5f0f\u4e0b\u96f6\u505c\u673a\u66f4\u65b0",id:"\u96c6\u7fa4\u6a21\u5f0f\u4e0b\u96f6\u505c\u673a\u66f4\u65b0",level:3},{value:"\u2753 \u5e38\u89c1\u95ee\u9898",id:"-\u5e38\u89c1\u95ee\u9898",level:2},{value:"Q1: \u5e94\u7528\u9891\u7e41\u91cd\u542f",id:"q1-\u5e94\u7528\u9891\u7e41\u91cd\u542f",level:3},{value:"Q2: \u5185\u5b58\u6301\u7eed\u589e\u957f",id:"q2-\u5185\u5b58\u6301\u7eed\u589e\u957f",level:3},{value:"Q3: \u5982\u4f55\u67e5\u770b\u5e94\u7528\u72b6\u6001",id:"q3-\u5982\u4f55\u67e5\u770b\u5e94\u7528\u72b6\u6001",level:3},{value:"\ud83d\udcda \u53c2\u8003\u8d44\u6599",id:"-\u53c2\u8003\u8d44\u6599",level:2}];function p(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"pm2-\u4f7f\u7528\u6307\u5357",children:"PM2 \u4f7f\u7528\u6307\u5357"})}),"\n",(0,a.jsx)(n.p,{children:"PM2 \u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684 Node.js \u8fdb\u7a0b\u7ba1\u7406\u5de5\u5177\uff0c\u7528\u4e8e\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u7ba1\u7406\u548c\u4fdd\u6301\u5e94\u7528\u7a0b\u5e8f\u6301\u7eed\u8fd0\u884c\u3002"}),"\n",(0,a.jsx)(n.h2,{id:"-\u5b89\u88c5",children:"\ud83d\udce6 \u5b89\u88c5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u5168\u5c40\u5b89\u88c5 PM2\nnpm install pm2 -g\n\n# \u6216\u4f7f\u7528 yarn\nyarn global add pm2\n"})}),"\n",(0,a.jsx)(n.h2,{id:"-\u57fa\u672c\u4f7f\u7528",children:"\ud83d\ude80 \u57fa\u672c\u4f7f\u7528"}),"\n",(0,a.jsx)(n.h3,{id:"\u542f\u52a8\u5e94\u7528",children:"\u542f\u52a8\u5e94\u7528"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# \u542f\u52a8\u5e94\u7528\npm2 start app.js\n\n# \u6307\u5b9a\u5e94\u7528\u540d\u79f0\npm2 start app.js --name "my-app"\n\n# \u542f\u52a8\u5e76\u76d1\u542c\u6587\u4ef6\u53d8\u5316\uff08\u5f00\u53d1\u6a21\u5f0f\uff09\npm2 start app.js --watch\n\n# \u542f\u52a8\u65f6\u6307\u5b9a\u5b9e\u4f8b\u6570\u91cf\uff08\u96c6\u7fa4\u6a21\u5f0f\uff09\npm2 start app.js -i max  # \u4f7f\u7528\u6240\u6709 CPU \u6838\u5fc3\npm2 start app.js -i 4    # \u542f\u52a8 4 \u4e2a\u5b9e\u4f8b\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u5e38\u7528\u542f\u52a8\u53c2\u6570",children:"\u5e38\u7528\u542f\u52a8\u53c2\u6570"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\npm2 start app.js --env production\n\n# \u6307\u5b9a\u65e5\u5fd7\u6587\u4ef6\npm2 start app.js --log /path/to/log.log\n\n# \u8bbe\u7f6e\u5185\u5b58\u9650\u5236\uff0c\u8d85\u8fc7\u540e\u81ea\u52a8\u91cd\u542f\npm2 start app.js --max-memory-restart 200M\n\n# \u5ef6\u8fdf\u91cd\u542f\uff08\u5d29\u6e83\u540e\u7b49\u5f85 3 \u79d2\u518d\u91cd\u542f\uff09\npm2 start app.js --restart-delay 3000\n"})}),"\n",(0,a.jsx)(n.h2,{id:"-\u8fdb\u7a0b\u7ba1\u7406",children:"\ud83d\udccb \u8fdb\u7a0b\u7ba1\u7406"}),"\n",(0,a.jsx)(n.h3,{id:"\u67e5\u770b\u8fdb\u7a0b\u5217\u8868",children:"\u67e5\u770b\u8fdb\u7a0b\u5217\u8868"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u67e5\u770b\u6240\u6709\u8fdb\u7a0b\npm2 list\n\n# \u67e5\u770b\u8be6\u7ec6\u4fe1\u606f\npm2 show <app-name>\n\n# \u5b9e\u65f6\u76d1\u63a7\u9762\u677f\npm2 monit\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u63a7\u5236\u8fdb\u7a0b",children:"\u63a7\u5236\u8fdb\u7a0b"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u91cd\u542f\u5e94\u7528\npm2 restart <app-name>\npm2 restart all          # \u91cd\u542f\u6240\u6709\n\n# \u505c\u6b62\u5e94\u7528\npm2 stop <app-name>\npm2 stop all             # \u505c\u6b62\u6240\u6709\n\n# \u5220\u9664\u5e94\u7528\npm2 delete <app-name>\npm2 delete all           # \u5220\u9664\u6240\u6709\n\n# \u91cd\u8f7d\u5e94\u7528\uff08\u96f6\u505c\u673a\u91cd\u542f\uff0c\u9002\u7528\u4e8e\u96c6\u7fa4\u6a21\u5f0f\uff09\npm2 reload <app-name>\npm2 reload all\n"})}),"\n",(0,a.jsx)(n.h2,{id:"-\u65e5\u5fd7\u7ba1\u7406",children:"\ud83d\udcdd \u65e5\u5fd7\u7ba1\u7406"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u67e5\u770b\u6240\u6709\u65e5\u5fd7\npm2 logs\n\n# \u67e5\u770b\u6307\u5b9a\u5e94\u7528\u65e5\u5fd7\npm2 logs <app-name>\n\n# \u67e5\u770b\u6700\u8fd1 200 \u884c\u65e5\u5fd7\npm2 logs --lines 200\n\n# \u6e05\u7a7a\u65e5\u5fd7\npm2 flush\n\n# \u65e5\u5fd7\u8f6e\u8f6c\uff08\u9700\u8981\u5b89\u88c5 pm2-logrotate\uff09\npm2 install pm2-logrotate\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\ufe0f-\u914d\u7f6e\u6587\u4ef6",children:"\u2699\ufe0f \u914d\u7f6e\u6587\u4ef6"}),"\n",(0,a.jsx)(n.p,{children:"\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u53ef\u4ee5\u66f4\u65b9\u4fbf\u5730\u7ba1\u7406\u590d\u6742\u7684\u5e94\u7528\u914d\u7f6e\u3002"}),"\n",(0,a.jsx)(n.h3,{id:"\u751f\u6210\u914d\u7f6e\u6587\u4ef6",children:"\u751f\u6210\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"pm2 ecosystem\n"})}),"\n",(0,a.jsx)(n.h3,{id:"ecosystemconfigjs-\u793a\u4f8b",children:"ecosystem.config.js \u793a\u4f8b"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"module.exports = {\n  apps: [\n    {\n      name: 'my-app',\n      script: './app.js',\n      instances: 'max',\n      exec_mode: 'cluster',\n      watch: false,\n      max_memory_restart: '1G',\n      env: {\n        NODE_ENV: 'development',\n        PORT: 3000\n      },\n      env_production: {\n        NODE_ENV: 'production',\n        PORT: 8080\n      },\n      // \u65e5\u5fd7\u914d\u7f6e\n      log_date_format: 'YYYY-MM-DD HH:mm:ss',\n      error_file: './logs/error.log',\n      out_file: './logs/out.log',\n      merge_logs: true,\n      // \u91cd\u542f\u7b56\u7565\n      max_restarts: 10,\n      restart_delay: 4000,\n      autorestart: true\n    }\n  ],\n  \n  // \u90e8\u7f72\u914d\u7f6e\uff08\u53ef\u9009\uff09\n  deploy: {\n    production: {\n      user: 'root',\n      host: 'your-server.com',\n      ref: 'origin/main',\n      repo: 'git@github.com:user/repo.git',\n      path: '/var/www/production',\n      'post-deploy': 'npm install && pm2 reload ecosystem.config.js --env production'\n    }\n  }\n};\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u542f\u52a8",children:"\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u542f\u52a8"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u542f\u52a8\u6240\u6709\u5e94\u7528\npm2 start ecosystem.config.js\n\n# \u542f\u52a8\u6307\u5b9a\u5e94\u7528\npm2 start ecosystem.config.js --only my-app\n\n# \u4f7f\u7528\u751f\u4ea7\u73af\u5883\u914d\u7f6e\npm2 start ecosystem.config.js --env production\n"})}),"\n",(0,a.jsx)(n.h2,{id:"-\u5f00\u673a\u81ea\u542f\u52a8",children:"\ud83d\udd04 \u5f00\u673a\u81ea\u542f\u52a8"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u751f\u6210\u542f\u52a8\u811a\u672c\npm2 startup\n\n# \u4fdd\u5b58\u5f53\u524d\u8fdb\u7a0b\u5217\u8868\npm2 save\n\n# \u6062\u590d\u4e4b\u524d\u4fdd\u5b58\u7684\u8fdb\u7a0b\npm2 resurrect\n\n# \u53d6\u6d88\u5f00\u673a\u81ea\u542f\u52a8\npm2 unstartup\n"})}),"\n",(0,a.jsx)(n.h2,{id:"-\u76d1\u63a7\u4e0e\u8bca\u65ad",children:"\ud83d\udcca \u76d1\u63a7\u4e0e\u8bca\u65ad"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u5b9e\u65f6\u76d1\u63a7\u9762\u677f\npm2 monit\n\n# \u67e5\u770b\u8fdb\u7a0b\u8be6\u60c5\npm2 describe <app-name>\n\n# \u67e5\u770b\u8fdb\u7a0b\u4fe1\u606f\uff08JSON \u683c\u5f0f\uff09\npm2 jlist\n\n# \u91cd\u7f6e\u91cd\u542f\u8ba1\u6570\npm2 reset <app-name>\n"})}),"\n",(0,a.jsx)(n.h2,{id:"-pm2-plus\u53ef\u9009",children:"\ud83c\udf10 PM2 Plus\uff08\u53ef\u9009\uff09"}),"\n",(0,a.jsx)(n.p,{children:"PM2 \u63d0\u4f9b\u4e86\u4e00\u4e2a Web \u76d1\u63a7\u5e73\u53f0 PM2 Plus\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u8fde\u63a5\u5230 PM2 Plus\npm2 plus\n"})}),"\n",(0,a.jsx)(n.h2,{id:"-\u5e38\u7528\u6280\u5de7",children:"\ud83d\udca1 \u5e38\u7528\u6280\u5de7"}),"\n",(0,a.jsx)(n.h3,{id:"\u5feb\u901f\u91cd\u542f\u6240\u6709\u5e94\u7528",children:"\u5feb\u901f\u91cd\u542f\u6240\u6709\u5e94\u7528"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"pm2 restart all --update-env\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u4f18\u96c5\u5173\u95ed\u5e94\u7528",children:"\u4f18\u96c5\u5173\u95ed\u5e94\u7528"}),"\n",(0,a.jsxs)(n.p,{children:["\u5728\u4ee3\u7801\u4e2d\u5904\u7406 ",(0,a.jsx)(n.code,{children:"SIGINT"})," \u4fe1\u53f7\uff1a"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"process.on('SIGINT', () => {\n  // \u6e05\u7406\u8d44\u6e90\n  db.close();\n  server.close(() => {\n    process.exit(0);\n  });\n});\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u67e5\u770b-cpu-\u548c\u5185\u5b58\u4f7f\u7528",children:"\u67e5\u770b CPU \u548c\u5185\u5b58\u4f7f\u7528"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"pm2 monit\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u96c6\u7fa4\u6a21\u5f0f\u4e0b\u96f6\u505c\u673a\u66f4\u65b0",children:"\u96c6\u7fa4\u6a21\u5f0f\u4e0b\u96f6\u505c\u673a\u66f4\u65b0"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"pm2 reload all\n"})}),"\n",(0,a.jsx)(n.h2,{id:"-\u5e38\u89c1\u95ee\u9898",children:"\u2753 \u5e38\u89c1\u95ee\u9898"}),"\n",(0,a.jsx)(n.h3,{id:"q1-\u5e94\u7528\u9891\u7e41\u91cd\u542f",children:"Q1: \u5e94\u7528\u9891\u7e41\u91cd\u542f"}),"\n",(0,a.jsx)(n.p,{children:"\u68c0\u67e5\u65e5\u5fd7\u627e\u51fa\u5d29\u6e83\u539f\u56e0\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"pm2 logs <app-name> --lines 100\n"})}),"\n",(0,a.jsx)(n.h3,{id:"q2-\u5185\u5b58\u6301\u7eed\u589e\u957f",children:"Q2: \u5185\u5b58\u6301\u7eed\u589e\u957f"}),"\n",(0,a.jsx)(n.p,{children:"\u8bbe\u7f6e\u5185\u5b58\u9650\u5236\u81ea\u52a8\u91cd\u542f\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"pm2 start app.js --max-memory-restart 500M\n"})}),"\n",(0,a.jsx)(n.h3,{id:"q3-\u5982\u4f55\u67e5\u770b\u5e94\u7528\u72b6\u6001",children:"Q3: \u5982\u4f55\u67e5\u770b\u5e94\u7528\u72b6\u6001"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"pm2 status\n# \u6216\npm2 list\n"})}),"\n",(0,a.jsx)(n.h2,{id:"-\u53c2\u8003\u8d44\u6599",children:"\ud83d\udcda \u53c2\u8003\u8d44\u6599"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://pm2.keymetrics.io/docs/usage/quick-start/",children:"PM2 \u5b98\u65b9\u6587\u6863"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://github.com/Unitech/pm2",children:"PM2 GitHub"})}),"\n"]})]})}function o(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(p,{...e})}):p(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>d});var l=s(6540);const a={},i=l.createContext(a);function r(e){const n=l.useContext(i);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),l.createElement(i.Provider,{value:n},e.children)}}}]);